<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timesheet Calendar</title>
  <style>
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #323232;
  color: #e0e0e0;
  margin: 12px;
}

.annotation-block {
  border: 1px solid #bbbbbb;
  box-shadow: 0 0 5px rgba(58, 154, 237, 0.2);
  padding: 8px;
  margin-bottom: 16px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

td.title {
  white-space: nowrap;
  padding: 2px 10px 2px 0;
  color: #cccccc;
  font-size: 0.8em;
  vertical-align: top;
  width: 160px;
}

.value {
  color: #bbbbbb;
  background-color: #1e1e1e;
  font-size: 0.8em;
  vertical-align: top;
  padding: 3px;
  margin: 3px;
}

.translated {
  margin-top: 8px;
}

.translated span {
  font-weight: bold;
  color: #87cefa;
}

.translated-text {
  color: #dddddd;
  font-size: 0.8em;
  background-color: #1e1e1e;
  border-left: 4px solid #3a9aed; 
  padding: 3px;
  margin: 3px;
  padding-left: 6px;
  margin-bottom: 6px;
}
  </style>
</head>
<body>
  <h1>Timesheet Calendar</h1>
  <div id="timesheet-container">Loading...</div>

<script>
try {
  const raw = expression.evaluate("CASE WHEN XXXX is NULL THEN '{}' WHEN XXXX is not NULL THEN to_json(XXXX) END");
  const timesheetData = JSON.parse(raw);
  const container = document.getElementById('timesheet-container');

  if (Object.keys(timesheetData).length === 0) {
    container.textContent = "Null";
  } else {
    const grouped = {};
    timesheetData.forEach(entry => {
      if (!grouped[entry.day]) grouped[entry.day] = [];
      grouped[entry.day].push(entry);
    });

    const container = document.getElementById('timesheet-container');
    container.innerHTML = '';

    function formatTimePoint(time, event, relative, interpretation) {
      // Clean empty or null
      time = time?.trim() || '';
      event = event?.trim() || '';
      relative = (relative && relative !== '(unknown)') ? relative.trim() : '';
      interpretation = interpretation?.trim() || '';

      // Priority rules based on AIXM:
      if (time && !event) {
        return time;
      } else if (!time && event) {
        return relative ? `${event} ${relative}` : event;
      } else if (time && event) {
        let interpStr = '';
        switch (interpretation.toLowerCase()) {
          case 'after':
            interpStr = `after ${event} by ${relative || '0min'} or ${time}`;
            break;
          case 'before':
            interpStr = `before ${event} by ${relative || '0min'} or ${time}`;
            break;
          case 'coincides':
            interpStr = `at ${event} (${time})`;
            break;
          default:
            interpStr = `${event} ${relative || ''} and ${time}`;
        }
        return interpStr.trim();
      }

      return '??';
    }

    for (const day in grouped) {
      grouped[day].forEach(entry => {
        const block = document.createElement('div');
        block.className = 'annotation-block';

        let start = formatTimePoint(
          entry.starttime,
          entry.startevent,
          entry.starttimerelativeevent,
          entry.starteventinterpretation
        );

        let end = formatTimePoint(
          entry.endtime,
          entry.endevent,
          entry.endtimerelativeevent,
          entry.endeventinterpretation
        );

        let timeRange = `${start} â†’ ${end}`;

        block.innerHTML = `
          <table>
            <tr>
              <td class="title">Valid Days</td>
              <td><div class="value">${entry.day}${entry.daytil ? ` to ${entry.daytil}` : ''}</div></td>
            </tr>
            <tr>
              <td class="title">Date Range</td>
              <td><div class="value">${entry.startdate} to ${entry.enddate}</div></td>
            </tr>
            <tr>
              <td class="title">Time Reference</td>
              <td><div class="value">${entry.timereference}</div></td>
            </tr>
            <tr>
              <td class="title">Time Range</td>
              <td><div class="value">${timeRange}</div></td>
            </tr>
            <tr>
              <td class="title">DST Adjustment</td>
              <td><div class="value">${entry.daylightsavingadjust}</div></td>
            </tr>
            <tr>
              <td class="title">Excluded</td>
              <td><div class="value">${entry.excluded}</div></td>
            </tr>
          </table>
        `;

        container.appendChild(block);
      });
    }
  }
} catch (e) {
  document.getElementById('timesheet-container').textContent = "Error: " + e;
}
</script>

</body>
</html>
